<!DOCTYPE html>
<html lang="en">
  <%- include('partials/head', { title: 'Home page | Members Only' }) %>
  <body>
    <%- include('partials/nav') %>

    <main>
      <% 
        const user = locals.currentUser;
        const msgs = locals.messages || [];
        const isMember = Boolean(user && user.membership);
      %>

      <% if (user) { %>
        <h2>Welcome back <%= user.fullname %>!</h2>
      <% } else { %>
        <h2>Welcome to Members Only!</h2>
        <p>To create a message, you need to <a href="/login">login</a> first.</p>
      <% } %>

      <% if (msgs.length > 0) { %>
        <div class="messages">
          <h3>Messages</h3>

          <% msgs.forEach(message => { 
               const dateStr = new Date(message.created_at).toLocaleDateString();
               const username = isMember ? message.username : '█'.repeat(message.username.length);
               const date = isMember ? dateStr : '█'.repeat(dateStr.length);
               const status = message.admin ? '[ADMIN]' : (message.membership ? '[MEMBER]' : '[NOT MEMBER]');
          %>
            <div class="message">
              <p><%= username %> on <%= date %>, <%= status %></p>
              <h4><%= message.title %></h4>
              <p><%= message.text %></p>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <p>No messages yet. Be the first to post!</p>
      <% } %>
    </main>

    <%- include('partials/footer') %>
  </body>
</html>
